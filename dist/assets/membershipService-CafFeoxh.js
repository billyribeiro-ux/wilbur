import{s as i}from"./index-5mCKK58T.js";async function l(s,o){try{console.log("[MembershipService] ðŸ” Validating membership:",{userId:s,roomId:o});const{data:e,error:r}=await i.from("room_memberships").select("*").eq("user_id",s).eq("room_id",o).single();return r?r.code==="PGRST116"?(console.warn("[MembershipService] âš ï¸ User not a member of room"),{isValid:!1,error:"User is not a member of this room",errorCode:"NOT_FOUND"}):r.message.includes("policy")?(console.error("[MembershipService] âŒ RLS policy denied access"),{isValid:!1,error:"Access denied by security policy",errorCode:"RLS_DENIED"}):(console.error("[MembershipService] âŒ Database error:",r),{isValid:!1,error:r.message,errorCode:"NETWORK_ERROR"}):e?(console.log("[MembershipService] âœ… Membership validated:",e.role),{isValid:!0,membership:e}):(console.warn("[MembershipService] âš ï¸ No membership data returned"),{isValid:!1,error:"Membership not found",errorCode:"NOT_FOUND"})}catch(e){return console.error("[MembershipService] âŒ Fatal error:",e),{isValid:!1,error:e instanceof Error?e.message:"Unknown error",errorCode:"NETWORK_ERROR"}}}async function b(s,o,e="member"){try{console.log("[MembershipService] ðŸ“ Creating membership:",{userId:s,roomId:o,role:e});const{data:r,error:a}=await i.from("users").select("id").eq("id",s).single();if(a||!r)return{isValid:!1,error:"User not found",errorCode:"INVALID_DATA"};const{data:n,error:c}=await i.from("rooms").select("id").eq("id",o).single();if(c||!n)return{isValid:!1,error:"Room not found",errorCode:"INVALID_DATA"};const d={user_id:s,room_id:o,role:e,joined_at:new Date().toISOString()},{data:m,error:t}=await i.from("room_memberships").insert(d).select().single();return t?t.code==="23505"?(console.log("[MembershipService] â„¹ï¸ Membership already exists, fetching..."),l(s,o)):(console.error("[MembershipService] âŒ Failed to create membership:",t),{isValid:!1,error:t.message,errorCode:"NETWORK_ERROR"}):m?(console.log("[MembershipService] âœ… Membership created successfully"),{isValid:!0,membership:m}):{isValid:!1,error:"Failed to create membership",errorCode:"NETWORK_ERROR"}}catch(r){return console.error("[MembershipService] âŒ Fatal error:",r),{isValid:!1,error:r instanceof Error?r.message:"Unknown error",errorCode:"NETWORK_ERROR"}}}async function f(s){try{const{data:o,error:e}=await i.from("room_memberships").select("*").eq("user_id",s);return e?(console.error("[MembershipService] âŒ Failed to fetch memberships:",e),[]):o||[]}catch(o){return console.error("[MembershipService] âŒ Fatal error:",o),[]}}async function p(s,o,e){const r=await l(s,o);if(!r.isValid||!r.membership)return!1;const a={admin:3,moderator:2,member:1},n=a[r.membership.role]||0,c=a[e];return n>=c}export{b as createMembership,f as getUserMemberships,p as hasRole,l as validateMembership};
//# sourceMappingURL=membershipService-CafFeoxh.js.map
