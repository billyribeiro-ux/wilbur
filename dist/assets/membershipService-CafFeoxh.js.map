{"version":3,"file":"membershipService-CafFeoxh.js","sources":["../../src/services/membershipService.ts"],"sourcesContent":["/**\n * ENTERPRISE GRADE: Room Membership Service\n * ============================================================================\n * Microsoft Azure AD B2C Pattern: Explicit membership management\n * No auto-creation - all memberships must be explicitly granted\n * ============================================================================\n */\n\nimport { supabase } from '../lib/supabase';\nimport type { Database } from '../types/database.types';\n\ntype RoomMembership = Database['public']['Tables']['room_memberships']['Row'];\ntype RoomMembershipInsert = Database['public']['Tables']['room_memberships']['Insert'];\n\nexport interface MembershipValidationResult {\n  isValid: boolean;\n  membership?: RoomMembership;\n  error?: string;\n  errorCode?: 'NOT_FOUND' | 'RLS_DENIED' | 'NETWORK_ERROR' | 'INVALID_DATA';\n}\n\n/**\n * ENTERPRISE PATTERN: Validate user membership with detailed error reporting\n * Returns structured result with error codes for proper error handling\n */\nexport async function validateMembership(\n  userId: string,\n  roomId: string\n): Promise<MembershipValidationResult> {\n  try {\n    console.log('[MembershipService] üîê Validating membership:', { userId, roomId });\n\n    // Query with proper error handling\n    const { data, error } = await supabase\n      .from('room_memberships')\n      .select('*')\n      .eq('user_id', userId)\n      .eq('room_id', roomId)\n      .single();\n\n    // Handle specific error cases\n    if (error) {\n      // PGRST116 = No rows found - user not a member\n      if (error.code === 'PGRST116') {\n        console.warn('[MembershipService] ‚ö†Ô∏è User not a member of room');\n        return {\n          isValid: false,\n          error: 'User is not a member of this room',\n          errorCode: 'NOT_FOUND'\n        };\n      }\n\n      // RLS policy denied access\n      if (error.message.includes('policy')) {\n        console.error('[MembershipService] ‚ùå RLS policy denied access');\n        return {\n          isValid: false,\n          error: 'Access denied by security policy',\n          errorCode: 'RLS_DENIED'\n        };\n      }\n\n      // Network or other error\n      console.error('[MembershipService] ‚ùå Database error:', error);\n      return {\n        isValid: false,\n        error: error.message,\n        errorCode: 'NETWORK_ERROR'\n      };\n    }\n\n    // No data returned\n    if (!data) {\n      console.warn('[MembershipService] ‚ö†Ô∏è No membership data returned');\n      return {\n        isValid: false,\n        error: 'Membership not found',\n        errorCode: 'NOT_FOUND'\n      };\n    }\n\n    // Success\n    console.log('[MembershipService] ‚úÖ Membership validated:', data.role);\n    return {\n      isValid: true,\n      membership: data as RoomMembership\n    };\n\n  } catch (error) {\n    console.error('[MembershipService] ‚ùå Fatal error:', error);\n    return {\n      isValid: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n      errorCode: 'NETWORK_ERROR'\n    };\n  }\n}\n\n/**\n * ENTERPRISE PATTERN: Create membership with proper validation\n * Only callable by room admins or system\n */\nexport async function createMembership(\n  userId: string,\n  roomId: string,\n  role: 'admin' | 'moderator' | 'member' = 'member'\n): Promise<MembershipValidationResult> {\n  try {\n    console.log('[MembershipService] üìù Creating membership:', { userId, roomId, role });\n\n    // Verify user exists\n    const { data: user, error: userError } = await supabase\n      .from('users')\n      .select('id')\n      .eq('id', userId)\n      .single();\n\n    if (userError || !user) {\n      return {\n        isValid: false,\n        error: 'User not found',\n        errorCode: 'INVALID_DATA'\n      };\n    }\n\n    // Verify room exists\n    const { data: room, error: roomError } = await supabase\n      .from('rooms')\n      .select('id')\n      .eq('id', roomId)\n      .single();\n\n    if (roomError || !room) {\n      return {\n        isValid: false,\n        error: 'Room not found',\n        errorCode: 'INVALID_DATA'\n      };\n    }\n\n    // Create membership\n    const membershipData: RoomMembershipInsert = {\n      user_id: userId,\n      room_id: roomId,\n      role,\n      joined_at: new Date().toISOString()\n    };\n\n    const { data, error } = await supabase\n      .from('room_memberships')\n      .insert(membershipData)\n      .select()\n      .single();\n\n    if (error) {\n      // Handle duplicate key error (membership already exists)\n      if (error.code === '23505') {\n        console.log('[MembershipService] ‚ÑπÔ∏è Membership already exists, fetching...');\n        return validateMembership(userId, roomId);\n      }\n\n      console.error('[MembershipService] ‚ùå Failed to create membership:', error);\n      return {\n        isValid: false,\n        error: error.message,\n        errorCode: 'NETWORK_ERROR'\n      };\n    }\n\n    if (!data) {\n      return {\n        isValid: false,\n        error: 'Failed to create membership',\n        errorCode: 'NETWORK_ERROR'\n      };\n    }\n\n    console.log('[MembershipService] ‚úÖ Membership created successfully');\n    return {\n      isValid: true,\n      membership: data as RoomMembership\n    };\n\n  } catch (error) {\n    console.error('[MembershipService] ‚ùå Fatal error:', error);\n    return {\n      isValid: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n      errorCode: 'NETWORK_ERROR'\n    };\n  }\n}\n\n/**\n * ENTERPRISE PATTERN: Get all user memberships\n */\nexport async function getUserMemberships(userId: string): Promise<RoomMembership[]> {\n  try {\n    const { data, error } = await supabase\n      .from('room_memberships')\n      .select('*')\n      .eq('user_id', userId);\n\n    if (error) {\n      console.error('[MembershipService] ‚ùå Failed to fetch memberships:', error);\n      return [];\n    }\n\n    return (data as RoomMembership[]) || [];\n  } catch (error) {\n    console.error('[MembershipService] ‚ùå Fatal error:', error);\n    return [];\n  }\n}\n\n/**\n * ENTERPRISE PATTERN: Check if user has specific role in room\n */\nexport async function hasRole(\n  userId: string,\n  roomId: string,\n  requiredRole: 'admin' | 'moderator' | 'member'\n): Promise<boolean> {\n  const result = await validateMembership(userId, roomId);\n  \n  if (!result.isValid || !result.membership) {\n    return false;\n  }\n\n  const roleHierarchy = { admin: 3, moderator: 2, member: 1 };\n  const userRoleLevel = roleHierarchy[result.membership.role as keyof typeof roleHierarchy] || 0;\n  const requiredRoleLevel = roleHierarchy[requiredRole];\n\n  return userRoleLevel >= requiredRoleLevel;\n}\n"],"names":["validateMembership","userId","roomId","data","error","supabase","createMembership","role","user","userError","room","roomError","membershipData","getUserMemberships","hasRole","requiredRole","result","roleHierarchy","userRoleLevel","requiredRoleLevel"],"mappings":"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"}